name: AI Code Review with Auto-Approve

on:
  pull_request:
    branches: [main, develop]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Generate App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install
        run: npm ci
      
      - name: AI Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
        run: npm run ai-review || true
      
      - name: Post Review and Auto-Approve
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const fs = require('fs');
            let results;
            try {
              results = JSON.parse(fs.readFileSync('ai-review-results.json', 'utf8'));
            } catch (e) {
              console.log('No results');
              return;
            }
            
            const sev = { critical: 'ðŸ”´', error: 'ðŸŸ ', warning: 'ðŸŸ¡', info: 'ðŸ”µ' };
            const lab = { critical: 'CRITICAL', error: 'ERROR', warning: 'WARNING', info: 'INFO' };
            
            // Build inline comments
            let comments = [];
            if (results.issues && results.issues.length > 0) {
              for (const fd of results.issues) {
                for (const iss of fd.issues) {
                  let body = sev[iss.severity] + ' **' + lab[iss.severity] + ': ' + (iss.category || 'GENERAL').toUpperCase() + '**\n\n';
                  body += '**Problem:** ' + iss.issue + '\n\n';
                  if (iss.code) body += '**Code:**\n```svelte\n' + iss.code + '\n```\n\n';
                  if (iss.suggestion) body += '**Fix:**\n```svelte\n' + iss.suggestion + '\n```\n\n';
                  if (iss.impact) body += '**Impact:** ' + iss.impact + '\n\n';
                  body += '\n_AI Review by Claude_';
                  comments.push({ path: fd.file, line: iss.line, body });
                }
              }
            }
            
            // Determine review event
            let reviewEvent = 'APPROVE';
            let body = '## ðŸ¤– AI Code Review\n\n';
            
            if (results.filesReviewed === 0) {
              body += 'âœ… **No Svelte files changed**\n\n';
              reviewEvent = 'APPROVE';
            } else if (results.criticalCount > 0) {
              reviewEvent = 'REQUEST_CHANGES';
              body += 'ðŸ”´ **CRITICAL ISSUES - Changes Required**\n\n';
              body += '- Files: ' + results.filesReviewed + '\n';
              body += '- Critical: ' + results.criticalCount + '\n';
              body += '- Errors: ' + results.errorCount + '\n';
              body += '- Warnings: ' + results.warningCount + '\n\n';
              body += 'âŒ **Cannot auto-approve - fix critical issues first**\n';
            } else if (results.errorCount > 0) {
              reviewEvent = 'COMMENT';
              body += 'ðŸŸ  **Errors Found**\n\n';
              body += '- Files: ' + results.filesReviewed + '\n';
              body += '- Errors: ' + results.errorCount + '\n';
              body += '- Warnings: ' + results.warningCount + '\n\n';
              body += 'âš ï¸ **Review recommended before merging**\n';
            } else if (results.warningCount > 0) {
              reviewEvent = 'APPROVE';
              body += 'âœ… **Approved with Minor Warnings**\n\n';
              body += '- Files: ' + results.filesReviewed + '\n';
              body += '- Warnings: ' + results.warningCount + '\n\n';
              body += 'âœ… **Auto-approved by AI - safe to merge**\n';
            } else {
              reviewEvent = 'APPROVE';
              body += 'âœ… **All Checks Passed!**\n\n';
              body += '- Files: ' + results.filesReviewed + '\n';
              body += '- No issues found\n\n';
              body += 'âœ… **Auto-approved by AI - safe to merge**\n';
            }
            
            if (results.changedFiles && results.changedFiles.length > 0) {
              body += '\n**Reviewed Files:**\n';
              results.changedFiles.forEach(f => body += '- `' + f + '`\n');
            }
            
            // Post review
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                event: reviewEvent,
                body: body,
                comments: comments
              });
              console.log('Review posted:', reviewEvent);
            } catch (err) {
              console.log('Error:', err.message);
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
      
      - name: Enable Auto-Merge
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const fs = require('fs');
            let results;
            try {
              results = JSON.parse(fs.readFileSync('ai-review-results.json', 'utf8'));
            } catch (e) {
              return;
            }
            
            // Only enable auto-merge if no critical issues
            if (results.criticalCount === 0 && results.errorCount === 0) {
              try {
                await github.rest.pulls.enableAutoMerge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  merge_method: 'squash'
                });
                console.log('Auto-merge enabled');
              } catch (err) {
                console.log('Could not enable auto-merge:', err.message);
              }
            }