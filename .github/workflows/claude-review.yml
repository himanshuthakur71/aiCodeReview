name: AI Code Review

on:
  pull_request:
    branches: [main, develop]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Generate App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }}
          git branch -a
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install
        run: npm ci
      
      - name: AI Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_EVENT_NAME: pull_request
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: npm run ai-review || true
      
      - name: Post Review with Approval
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const fs = require('fs');
            let results;
            try {
              results = JSON.parse(fs.readFileSync('ai-review-results.json', 'utf8'));
            } catch (e) {
              console.log('No results file');
              return;
            }
            
            const sev = { critical: 'ðŸ”´', error: 'ðŸŸ ', warning: 'ðŸŸ¡', info: 'ðŸ”µ' };
            const lab = { critical: 'CRITICAL', error: 'ERROR', warning: 'WARNING', info: 'INFO' };
            
            let comments = [];
            if (results.issues && results.issues.length > 0) {
              for (const fd of results.issues) {
                for (const iss of fd.issues) {
                  let body = sev[iss.severity] + ' **' + lab[iss.severity] + ': ' + (iss.category || 'GENERAL').toUpperCase() + '**\n\n';
                  body += '**Problem:** ' + iss.issue + '\n\n';
                  if (iss.code) body += '**Code:**\n```svelte\n' + iss.code + '\n```\n\n';
                  if (iss.suggestion) body += '**Fix:**\n```svelte\n' + iss.suggestion + '\n```\n\n';
                  if (iss.impact) body += '**Impact:** ' + iss.impact + '\n\n';
                  body += '\n_AI Review by Claude_';
                  comments.push({ path: fd.file, line: iss.line, body });
                }
              }
            }
            
            let reviewEvent = 'APPROVE';
            let body = '## ðŸ¤– AI Code Review\n\n';
            
            if (results.filesReviewed === 0) {
              body += '**No Svelte files changed**\n\n';
              body += 'No review needed.\n';
              reviewEvent = 'APPROVE';
            } else if (results.criticalCount > 0) {
              reviewEvent = 'REQUEST_CHANGES';
              body += '**CRITICAL ISSUES FOUND**\n\n';
              body += '**Must be fixed before merging**\n\n';
              body += '**Summary:**\n';
              body += '- Files Reviewed: ' + results.filesReviewed + '\n';
              body += '- Critical: ' + results.criticalCount + '\n';
              body += '- Errors: ' + results.errorCount + '\n';
              body += '- Warnings: ' + results.warningCount + '\n';
            } else if (results.errorCount > 0) {
              reviewEvent = 'COMMENT';
              body += '**Errors Found**\n\n';
              body += 'Please review and fix.\n\n';
              body += '**Summary:**\n';
              body += '- Files Reviewed: ' + results.filesReviewed + '\n';
              body += '- Errors: ' + results.errorCount + '\n';
              body += '- Warnings: ' + results.warningCount + '\n';
            } else if (results.warningCount > 0) {
              reviewEvent = 'APPROVE';
              body += '**Approved with Minor Warnings**\n\n';
              body += 'Code is acceptable. Consider fixing warnings.\n\n';
              body += '**Summary:**\n';
              body += '- Files Reviewed: ' + results.filesReviewed + '\n';
              body += '- Warnings: ' + results.warningCount + '\n';
              body += '- Info: ' + results.infoCount + '\n';
            } else {
              reviewEvent = 'APPROVE';
              body += '**All Checks Passed**\n\n';
              body += 'No issues found!\n\n';
              body += '**Summary:**\n';
              body += '- Files Reviewed: ' + results.filesReviewed + '\n';
            }
            
            if (results.changedFiles && results.changedFiles.length > 0) {
              body += '\n**Files Reviewed:**\n';
              results.changedFiles.forEach(f => body += '- `' + f + '`\n');
            }
            
            if (results.analytics && results.analytics.insights) {
              body += '\n---\n' + results.analytics.insights;
            }
            
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                event: reviewEvent,
                body: body,
                comments: comments
              });
              console.log('Review posted:', reviewEvent);
            } catch (err) {
              console.log('Error posting review:', err.message);
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }